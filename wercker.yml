box: ruby
build:
    steps:
        - script:
          name: unstable debian
          code: |
            sudo chmod a+w /etc/apt/sources.list
            sudo echo 'deb http://ftp.us.debian.org/debian unstable main contrib non-free' >> /etc/apt/sources.list

        - install-packages:
          packages: brotli zopfli

        # Run a smart version of bundle install
        # which improves build execution time of
        # future builds
        - bundle-install

        - script:
            name: generate site
            code: bundle exec jekyll build --trace

        - script:
            name: zopfli
            code: find _site -type f | xargs zopfli --i50

        - script:
            name: brotli
            code: find _site -type f ! -name "*.gz" | xargs -I{} brotli --quality 11 --input {} --output {}.br

deploy:
  steps:
    - s3sync:
        key_id: $KEY
        key_secret: $SECRET
        bucket_url: $URL
        source_dir: _site/
        opts: --acl-public --delete-removed --exclude='*.gz'
    - s3sync:
        key_id: $KEY
        key_secret: $SECRET
        bucket_url: $URL
        source_dir: _site/
        opts: --acl-public --delete-removed --exclude='*' --include='*.gz' --add-header='Content-Encoding:gzip'
