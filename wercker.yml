box: ruby
build:
    steps:
        - script:
          name: unstable debian
          code: |
            sudo chmod a+w /etc/apt/sources.list
            sudo echo 'deb http://ftp.us.debian.org/debian unstable main contrib non-free' >> /etc/apt/sources.list

        - install-packages:
          packages: brotli zopfli

        # Run a smart version of bundle install
        # which improves build execution time of
        # future builds
        - bundle-install

        - script:
            name: generate site
            code: bundle exec jekyll build --trace

        - script:
            name: zopfli
            code: find _site -type f '!' -name '*.jpg' '!' -name '*.gif' '!' -name '*.png' '!' -name '*.jpg' | xargs zopfli --i50

        - script:
            name: brotli
            code: find _site -type f !' -name '*.jpg' '!' -name '*.gif' '!' -name '*.png' '!' -name '*.jpg' '!' -name "*.gz" | xargs -I{} brotli --quality 11 --input {} --output {}.br

deploy:
  steps:
    - wercker/s3sync@2.1.0:
        key_id: $KEY
        key_secret: $SECRET
        bucket_url: $URL
        source_dir: _site/
        opts: --guess-mime-type --acl-public --delete-removed --exclude='*.gz' --add-header="Cache-Control:public, max-age=3600"
    - wercker/s3sync@2.1.0:
        key_id: $KEY
        key_secret: $SECRET
        bucket_url: $URL
        opts: |
          --guess-mime-type --acl-public --delete-removed --exclude='*' --add-header="Cache-Control:public, max-age=3600" --add-header="Content-Encoding: gzip"
        source_dir: _site/
